<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AgroSmart Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:"Poppins",sans-serif;}
body{background:#f0f7f5;color:#222;min-height:100vh;display:flex;flex-direction:column;}
.top-menu{width:100%;background:#2e7d32;color:#fff;display:flex;align-items:center;padding:14px 20px;position:fixed;top:0;z-index:1000;box-shadow:0 2px 6px rgba(0,0,0,0.2);}
.top-menu h2{margin-right:auto;font-size:22px;font-weight:600;}
.top-menu button{margin-left:8px;padding:8px 12px;border-radius:8px;border:none;background:#388e3c;color:#fff;cursor:pointer;transition:0.3s;}
.top-menu button:hover{background:#1b5e20;}
.main-content{padding:100px 20px 40px 20px;max-width:1400px;margin:auto;display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));grid-gap:20px;}
.card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,0.08);display:flex;flex-direction:column;transition:0.3s;}
.card:hover{box-shadow:0 12px 35px rgba(0,0,0,0.12);}
h3{color:#1b5e20;margin-bottom:14px;font-size:18px;}
label{display:block;font-weight:600;margin-top:8px;margin-bottom:6px;}
input,select,textarea{width:100%;padding:10px;border:1px solid #d0d7d1;border-radius:10px;font-size:14px;transition:0.2s;}
input:focus,select:focus,textarea:focus{border-color:#2e7d32;outline:none;}
button.primary{background:#2e7d32;color:white;border:none;padding:10px;border-radius:10px;cursor:pointer;margin-top:10px;transition:0.3s;}
button.primary:hover{background:#1b5e20;}
.small{font-size:13px;padding:6px 8px;border-radius:8px;cursor:pointer;transition:0.3s;}
.small:hover{opacity:0.8;}
.output{background:#f6fff6;padding:10px;border-radius:10px;margin-top:10px;font-size:14px;min-height:40px;white-space:pre-line;}
.footer{margin-top:20px;padding:18px;background:linear-gradient(90deg,#2e7d32,#66bb6a);color:white;border-radius:12px;text-align:center;font-size:14px;}
.prev-data{max-height:180px;overflow:auto;padding:10px;background:#f0f7f0;border-radius:10px;font-size:13px;}
.note{font-size:13px;color:#555;margin-top:6px;}
@media(max-width:1000px){.main-content{grid-template-columns:1fr;}}
a.shop-link{color:#2e7d32;text-decoration:none;font-weight:600;}
a.shop-link:hover{text-decoration:underline;}
</style>
</head>
<body>

<div class="top-menu">
  <h2>üë®‚Äçüåæ AgroSmart Dashboard</h2>
  <button onclick="toggleLang()">üåê ‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
  <button onclick="openProfile()">Profile</button>
  <button onclick="logout()">Logout</button>
</div>

<div class="main-content">

  <!-- Plot Management -->
  <div class="card">
    <h3>üìå Plots</h3>
    <label>Add New Plot</label>
    <input id="newPlotName" placeholder="eg. Field A">
    <button class="primary" onclick="addPlot()">‚ûï Add Plot</button>

    <label style="margin-top:12px;">Select Plot</label>
    <select id="plotSelect" onchange="loadSelectedPlot()">
      <option value="">--Select a plot--</option>
    </select>

    <div style="display:flex;gap:8px;margin-top:8px;">
      <button class="small" onclick="editPlotName()" style="background:#0288d1;color:white;">‚úèÔ∏è Edit</button>
      <button class="small" onclick="deletePlot()" style="background:#e57373;color:white;">üóë Delete</button>
    </div>
    <div class="note">Select a plot to view or edit soil data.</div>
    <div id="plotList" class="prev-data"><em>No plots yet</em></div>
  </div>

  <!-- Soil Input & Analysis -->
  <div class="card">
    <h3>üå± Soil Input & Analysis</h3>
    <label>Crop</label>
    <select id="soilCrop">
      <option value="">--select crop--</option>
      <option value="wheat">Wheat</option>
      <option value="rice">Rice</option>
      <option value="maize">Maize</option>
      <option value="tomato">Tomato</option>
      <option value="potato">Potato</option>
    </select>

    <label>Soil pH</label>
    <input id="soilPH" type="number" step="0.1" min="0" max="14">

    <label>Moisture (%)</label>
    <input id="soilMoisture" type="number" step="1" min="0" max="100">

    <label>Soil Type</label>
    <select id="soilType">
      <option value="Loamy">Loamy</option>
      <option value="Sandy">Sandy</option>
      <option value="Clay">Clay</option>
      <option value="Silty">Silty</option>
    </select>

    <label>N-P-K (kg/acre)</label>
    <div style="display:flex;gap:5px;">
      <input id="soilN" type="number" placeholder="N" style="flex:1">
      <input id="soilP" type="number" placeholder="P" style="flex:1">
      <input id="soilK" type="number" placeholder="K" style="flex:1">
    </div>

    <button class="primary" onclick="saveSoil()">üíæ Save Soil</button>
    <div class="output" id="waterResults">Water requirement will appear here.</div>
  </div>

  <!-- Weather -->
  <div class="card">
    <h3>üå¶ Plot Weather (Real-time)</h3>
    <button class="primary" onclick="fetchWeatherLive()">üå§ Get Real-time Weather</button>
    <div id="plotWeatherInfo" class="output">
      <div><b>Plot:</b> <span id="wPlot">‚Äî</span></div>
      <div><b>Temp:</b> <span id="wTemp">‚Äî</span> ¬∞C</div>
      <div><b>Humidity:</b> <span id="wHum">‚Äî</span> %</div>
      <div><b>Rainfall:</b> <span id="wRain">‚Äî</span> mm</div>
      <div><b>Location:</b> <span id="wLoc">‚Äî</span></div>
       <a href="weather.html" style="border: #1b5e20; background-color: #1b5e20; border-radius: 10px;color: white;margin: 10px;padding: 10px;text-decoration: none;">Get more weather details</a>
    </div>
    <canvas id="weatherChartPlot" style="margin-top:12px;height:180px;"></canvas>
  </div>

  <!-- Fertilizer & Pesticide Advisory -->
  <div class="card">
    <h3>üß™ Fertilizer & Pesticide Advisory</h3>
    <div class="output" id="advResults">Soil data not selected yet.</div>
  </div>

  <!-- Crop Profitability -->
  <div class="card">
    <h3>üí∞ Crop Profitability Suggestion</h3>
    <div class="output" id="profitResults">Select soil & crop to see suggestion.</div>
  </div>

  <!-- Previous Soil Data -->
  <div class="card">
    <h3>üìú Previous Soil Data</h3>
    <div id="prevSoil" class="prev-data"><em>No previous entries</em></div>
  </div>

  <!-- Mandi Prices -->
  <div class="card wide">
    <h3>üìà Mandi Prices</h3>
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px;">
      <label style="margin:0">Crop:</label>
      <select id="marketCrop" style="width:180px;"></select>
      <button class="primary" onclick="renderMandiChart()">Refresh</button>
    </div>
    <canvas id="marketChartFull" style="height:300px;"></canvas>
  </div>

  <!-- Irrigation Motor -->
  <div class="card">
    <h3>üß∞ Irrigation & Motor</h3>
    <div>
      <label>Estimated runtime (minutes)</label>
      <input id="calcRun" readonly placeholder="‚Äî">
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
        <button class="primary" id="motorStart" onclick="startMotor()">‚ñ∂ Start</button>
        <button id="motorStop" onclick="stopMotor()">‚ñ† Stop</button>
        <div id="motorTimer">00:00:00</div>
      </div>
      <div id="motorLog" class="note">Motor not running</div>
    </div>
  </div>

</div>

<div class="footer">
  <strong>About AgroSmart</strong>
  <p>AgroSmart provides per-plot weather, soil analytics, irrigation suggestions, fertilizer/pesticide guidance, crop profitability, and mandi price intelligence. Data stored locally.</p>
</div>

<script>
const $ = id => document.getElementById(id);

// ----------------- Plots -----------------
let plots = JSON.parse(localStorage.getItem('ag_plots')||'[]');
function renderPlotList(){
  if(!plots.length){ 
    $('plotList').innerHTML='<em>No plots yet</em>'; 
    $('plotSelect').innerHTML='<option value="">--Select a plot--</option>'; 
    return;
  }
  $('plotList').innerHTML = plots.map(p=>`<div><b>${p.name}</b></div>`).join('');
  const sel = $('plotSelect');
  sel.innerHTML='<option value="">--Select a plot--</option>';
  plots.forEach((p,i)=>sel.appendChild(new Option(p.name,i)));
}
function addPlot(){
  const name = $('newPlotName').value.trim();
  if(!name){ alert('Enter plot name'); return; }
  plots.push({name,history:[]});
  localStorage.setItem('ag_plots',JSON.stringify(plots));
  $('newPlotName').value='';
  renderPlotList();
}
function editPlotName(){
  const selIndex=$('plotSelect').value;
  if(selIndex===''){ alert('Select a plot'); return; }
  const name=prompt('Enter new plot name',plots[selIndex].name);
  if(name){ plots[selIndex].name=name; localStorage.setItem('ag_plots',JSON.stringify(plots)); renderPlotList(); }
}
function deletePlot(){
  const selIndex=$('plotSelect').value;
  if(selIndex===''){ alert('Select a plot'); return; }
  if(confirm('Delete this plot?')){ plots.splice(selIndex,1); localStorage.setItem('ag_plots',JSON.stringify(plots)); renderPlotList(); }
}

// ----------------- Soil -----------------
function saveSoil(){
  const selIndex=$('plotSelect').value;
  if(selIndex===''){ alert('Select a plot'); return; }
  const crop=$('soilCrop').value;
  const ph=parseFloat($('soilPH').value);
  const moisture=parseFloat($('soilMoisture').value);
  const soilType=$('soilType').value;
  const N=parseFloat($('soilN').value)||0;
  const P=parseFloat($('soilP').value)||0;
  const K=parseFloat($('soilK').value)||0;
  if(!crop || isNaN(ph) || isNaN(moisture) || !soilType){ alert('Complete all soil fields'); return; }
  const entry={ts:Date.now(),crop,ph,moisture,soilType,N,P,K};
  plots[selIndex].history.push(entry);
  localStorage.setItem('ag_plots',JSON.stringify(plots));

  calcIrrigationField(entry);
  updateAdvisory(entry);
  updatePrevSoil(selIndex);
  updateProfitability(entry);
  fetchWeatherLive();
}

function updatePrevSoil(selIndex){
  const history=plots[selIndex].history;
  if(!history.length){ $('prevSoil').innerHTML='<em>No previous entries</em>'; return; }
  $('prevSoil').innerHTML=history.map(e=>`<div><b>${new Date(e.ts).toLocaleDateString()}</b> - Crop: ${e.crop}, pH:${e.ph}, Moist:${e.moisture}%, Type:${e.soilType}, NPK:${e.N}/${e.P}/${e.K}</div>`).join('');
}

// ----------------- Fertilizer & Pesticide Advisory -----------------
function updateAdvisory(entry){
  if(!entry){ $('advResults').innerText='Soil data not selected yet.'; return; }
  const {N,P,K,ph,soilType,crop,moisture} = entry;
  const fertProfiles = {
    wheat:{type:'Urea (46% N)', idealN:80, idealP:40, idealK:30},
    rice:{type:'DAP (18-46-0)', idealN:60, idealP:40, idealK:20},
    maize:{type:'NPK (20-20-0)', idealN:70, idealP:30, idealK:30},
    tomato:{type:'NPK (19-19-19)', idealN:60, idealP:40, idealK:40},
    potato:{type:'NPK (14-35-14)', idealN:50, idealP:50, idealK:30}
  };
  const fertBase = fertProfiles[crop];
  if(!fertBase){ $('advResults').innerText='Please select a valid crop for advisory.'; return; }
  const dN = Math.max(0, fertBase.idealN - N);
  const dP = Math.max(0, fertBase.idealP - P);
  const dK = Math.max(0, fertBase.idealK - K);
  const fertLink = `https://www.amazon.in/s?k=${encodeURIComponent(fertBase.type)}+fertilizer`;
  const fertRec = `
  üåæ <b>Crop:</b> ${crop.toUpperCase()}<br>
  üß™ <b>Fertilizer:</b> ${fertBase.type}<br>
  üì¶ <b>Required Quantity:</b> N:${dN.toFixed(1)} P:${dP.toFixed(1)} K:${dK.toFixed(1)} kg/acre<br>
  üß≠ <b>Soil Type:</b> ${soilType}<br>
  ‚öñÔ∏è <b>pH:</b> ${ph}<br>
  <a href="${fertLink}" target="_blank" class="shop-link">üõí Buy Fertilizer Online</a><br><br>
  `;
  const pestProfiles = {
    wheat:{pest:'Aphids', pesticide:'Imidacloprid 17.8% SL', method:'Foliar spray'},
    rice:{pest:'Brown Planthopper', pesticide:'Buprofezin 25% SC', method:'Soil drench'},
    maize:{pest:'Stem Borer', pesticide:'Chlorantraniliprole 18.5% SC', method:'Foliar spray'},
    tomato:{pest:'Early Blight', pesticide:'Mancozeb 75% WP', method:'Spray weekly'},
    potato:{pest:'Late Blight', pesticide:'Metalaxyl 8% + Mancozeb 64% WP', method:'Spray at 10-day intervals'}
  };
  const pestBase = pestProfiles[crop];
  const pestLink = `https://www.amazon.in/s?k=${encodeURIComponent(pestBase.pesticide)}`;
  let moistureAdvice='';
  if(moisture>70) moistureAdvice='‚ö†Ô∏è High moisture ‚Äî apply fungicide to prevent fungal growth.';
  else if(moisture<30) moistureAdvice='‚ö†Ô∏è Low moisture ‚Äî avoid spraying, irrigate first.';
  else moistureAdvice='‚úÖ Optimal moisture for effective pesticide action.';
  const pestRec = `
  üêõ <b>Common Pest:</b> ${pestBase.pest}<br>
  üíß <b>Pesticide:</b> ${pestBase.pesticide}<br>
  ‚öôÔ∏è <b>Application:</b> ${pestBase.method}<br>
  ${moistureAdvice}<br>
  <a href="${pestLink}" target="_blank" class="shop-link">üõí Buy Pesticide Online</a>
  `;
  $('advResults').innerHTML = fertRec + pestRec;
}

// ----------------- Crop Profitability -----------------
function updateProfitability(entry){
  const soilScore = entry.ph>=6 && entry.ph<=7 ? 2 : 1;
  let cropScore = {'wheat':2,'rice':3,'maize':1,'tomato':3,'potato':2};
  const bestCrop = Object.keys(cropScore).reduce((a,b)=>cropScore[b]>cropScore[a]?b:a);
  $('profitResults').innerText = `Based on current soil (pH ${entry.ph}) and moisture ${entry.moisture}%, best profitable crop nearby: ${bestCrop.toUpperCase()}.`;
}

// ----------------- Irrigation -----------------
function calcIrrigationField(entry){
  const {moisture,soilType,crop} = entry;
  const baseWater={Loamy:30,Sandy:40,Clay:25,Silty:35};
  const cropExtraWater={wheat:20,rice:25,maize:30,tomato:15,potato:18};
  const forecastedRainfall = Math.random()*10;
  let totalRequired = baseWater[soilType] + cropExtraWater[crop];
  let effectiveWater = Math.max(0, totalRequired - (moisture/100)*totalRequired - forecastedRainfall);
  const minutes = Math.max(0, (effectiveWater*0.8).toFixed(1));
  $('waterResults').innerText = `üíß Water needed: ${effectiveWater.toFixed(1)} mm | ‚è± Irrigate ~${minutes} min using 5kW pump. (Forecasted Rainfall considered: ${forecastedRainfall.toFixed(1)} mm)`;
  $('calcRun').value = minutes;
}

// ----------------- Motor -----------------
let motorTimerInt, secCount = 0, motorRunning = false;
const MOTOR_IO_MODE = false;
function startMotor(){
  if(motorRunning) return;
  motorRunning=true;
  secCount=0;
  $('motorLog').innerText='Motor running...';
  motorTimerInt=setInterval(()=>{ 
    secCount++; 
    const h=Math.floor(secCount/3600), m=Math.floor(secCount%3600/60), s=secCount%60;
    $('motorTimer').innerText=`${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
  },1000);
}
function stopMotor(){
  clearInterval(motorTimerInt);
  motorRunning=false;
  $('motorLog').innerText='Motor stopped.';
}

// ----------------- Weather -----------------
function fetchWeatherLive(){
  const selIndex=$('plotSelect').value;
  if(selIndex===''){ alert('Select a plot to get weather'); return; }
  if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
  navigator.geolocation.getCurrentPosition(async pos=>{
    const lat=pos.coords.latitude, lon=pos.coords.longitude;
    $('wPlot').innerText=plots[selIndex].name;
    $('wLoc').innerText=`${lat.toFixed(2)},${lon.toFixed(2)}`;
    const resp = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,precipitation,relativehumidity_2m`);
    const data = await resp.json();
    const cw = data.current_weather;
    $('wTemp').innerText=cw.temperature;
    $('wHum').innerText=data.hourly.relativehumidity_2m[0];
    $('wRain').innerText=data.hourly.precipitation[0];
  }, err=>alert('Location permission denied'));
}

// ----------------- Mandi Prices -----------------
const cropsMandi = ['Wheat','Rice','Maize','Tomato','Potato'];
cropsMandi.forEach(c=>$('marketCrop').appendChild(new Option(c,c)));
let marketChart=null;
const marketCtx = $('marketChartFull').getContext('2d');

function predictNext15Days(cropData){
  if(!cropData.length) return [];
  const prices = cropData.map(d=>d.price);
  const forecast=[];
  let lastDate = new Date(cropData[cropData.length-1].date);
  for(let i=0;i<15;i++){
    const last5 = prices.slice(-5);
    const nextPrice = Math.round(last5.reduce((a,b)=>a+b,0)/last5.length);
    lastDate.setDate(lastDate.getDate()+1);
    forecast.push({date:lastDate.toISOString().split('T')[0],price:nextPrice});
    prices.push(nextPrice);
  }
  return forecast;
}

async function fetchMandiData(crop){
  try{
    const resp = await fetch(`https://api.data.gov.in/resource/9ef84268-d588-465a-a308-a864a43d0070?api-key=YOUR_API_KEY_HERE&format=json&limit=15&filters[commodity]=${crop}`);
    const data = await resp.json();
    if(!data.records || !data.records.length) throw new Error('No data');
    return data.records.map(r=>({date:r.arrival_date,price:parseFloat(r.modal_price)}));
  }catch(e){
    const base = Math.floor(Math.random()*2000+1000);
    return Array.from({length:15},(_,i)=>({date:`Day-${i-14}`,price: base + Math.floor(Math.random()*100-50)}));
  }
}

async function renderMandiChart(){
  const crop = $('marketCrop').value || 'Wheat';
  const hist = await fetchMandiData(crop);
  const forecast = predictNext15Days(hist);
  const labels = [...hist.map(d=>d.date), ...forecast.map(d=>d.date)];
  const histValues = [...hist.map(d=>d.price), ...Array(forecast.length).fill(null)];
  const forecastValues = [...Array(hist.length).fill(null), ...forecast.map(d=>d.price)];
  if(marketChart) marketChart.destroy();
  marketChart = new Chart(marketCtx,{
    type:'line',
    data:{labels,datasets:[
      {label:`${crop} Historical (‚Çπ/qtl)`,data:histValues,borderColor:'#2e7d32',backgroundColor:'rgba(46,125,50,0.2)',tension:0.3},
      {label:`${crop} Forecast (‚Çπ/qtl)`,data:forecastValues,borderColor:'#ff9800',backgroundColor:'rgba(255,152,0,0.1)',borderDash:[8,5],tension:0.3}
    ]},
    options:{
      responsive:true,
      plugins:{title:{display:true,text:'üìà Mandi Prices (Historical + 15-day Forecast)'},tooltip:{mode:'index',intersect:false}},
      interaction:{mode:'nearest',axis:'x',intersect:false},
      scales:{y:{beginAtZero:false,title:{display:true,text:'Price (‚Çπ/qtl)'}},x:{title:{display:true,text:'Date'}}}
    }
  });
}

$('marketCrop').addEventListener('change', renderMandiChart);

// ----------------- Init -----------------
renderPlotList();
</script>
</body>
</html>
